describe("$.Class() suite", function() {
    jQuery.require("common/oop");

    var classBody, body, SuperClass, SubClass, SubSubClass,
        superClassObj, subClassObj, subSubClassObj;

    beforeEach(function() {
        classBody = {
            id: null,
            initialize: function(args) {
                if (args) this.id = args.id;
            },
            setMessage: function(msg) {
                this.message = msg;
            },
            colorize: function(id, color) {
                document.getElementById(id).style.color = color;
            },
            toString: function() {
                var i, props = "{";
                for (i in this) {
                    props += i + ":" + this[i] + ", ";
                }
                props = props.replace(/,\s$/, "");
                props += "}";
                return props;
            }
        };
        body = {};
        jQuery.extend(body, classBody);

        SuperClass = jQuery.Class(body);
        SubClass = jQuery.Class(SuperClass, {
            initialize: function(args) {
                if (args) this.id = "__subclass" + args.id + "__";
            },
            setMessage: function(msg) {
                this.message = 2 + 2 + msg;
            },
            newMethod: function() {
            }
        });
        SubSubClass = jQuery.Class(SubClass, {});
        superClassObj = new SuperClass({id: 'test'});
        subClassObj = new SubClass({id: 'child', newProp: "this should not be added"});
        subSubClassObj = new SubSubClass();
    });


    it("The resulting \"classes\" are actually just functions.", function(){
        expect($.isFunction(SuperClass)).toBeTruthy();
        expect($.isFunction(SubClass)).toBeTruthy();
        expect($.isFunction(SubSubClass)).toBeTruthy();
    });

    it("The resulting classes have prototypes.", function(){
        expect(SuperClass.prototype).toBeDefined();
        expect(SubClass.prototype).toBeDefined();
        expect(SubSubClass.prototype).toBeDefined();
    });

    it("In order for the \"instanceof\" to work as expected, the resulting class has to be the assigned to the constructor property of its instances.", function(){
        expect(superClassObj.constructor).toBe(SuperClass);
        expect(subClassObj.constructor).toBe(SubClass);
        expect(subSubClassObj.constructor).toBe(SubSubClass);
    });

    describe("initialization", function(){
        it("The initialize() method should be called when the constructor is invoked with the \"new\" keyword.", function(){
            expect(superClassObj.id).toEqual("test");
        });

        it("A default constructor should be created if no initialize() method is passed to $.Class()", function(){
            var MyGreatClass = $.Class({
                kill: function(){}
            });
            expect(MyGreatClass.prototype.initialize).toBeDefined();
        });

        it("The parameter-less constructor of the parent class should be called when a subclass' constructor is invoked with the \"new\" keyword.", function(){
            /*
            Below if the parent class constructor has been invoked, properties set by the parent constructor
            should have the values set by that constructor, unless reset by the subclass constructor.
             */
            var MyGreatClass = $.Class({
                id: null,
                initialize: function(){
                    this.id = 5;
                }
            });
            var MyGreatSubClass = $.Class(MyGreatClass, {});
            var instance = new MyGreatSubClass();
            expect(instance.id).toEqual(5);

            var MyGreatSubClass2 = $.Class(MyGreatClass, { id: 3, initialize: function(){ this.age = 6; } });
            var instance2 = new MyGreatSubClass2();
            expect(instance2.id).toEqual(5);
        });

        it("The subclass constructor should override settings made by the parent constructor.", function(){
            /*
            Below if the parent class constructor has been invoked, properties set by the parent constructor
            should have the values set by that constructor, unless reset by the subclass constructor.
             */
            var MyGreatClass = $.Class({
                id: null,
                initialize: function(){
                    this.id = 5;
                }
            });
            // In this case, the subclass has a constructor that overrides the settings made by the parent constructor.
            var MyGreatSubClass = $.Class(MyGreatClass, { initialize: function(id){ this.id = id; } });
            var instance = new MyGreatSubClass(6);
            expect(instance.id).toEqual(6);
        });

        it("Superclass constructors that have parameters should not be called automatically.", function(){
            var MyGreatClass = $.Class({
                id: null,
                initialize: function(id){
                    throw new Error("This constructor should not have been called.");
                }
            });

            var MyGreatSubClass = $.Class(MyGreatClass, {  });
            var instance = new MyGreatSubClass();
        });

        it("Unlike Java, no error should be thrown if parent has no parameter-less constructor.", function(){

        });

        it("Instances of classes should NOT have prototypes, because they aren't functions (like \"classes\" are).", function(){
            expect(superClassObj.prototype).toBeUndefined();
            expect(subClassObj.prototype).toBeUndefined();
            expect(subSubClassObj.prototype).toBeUndefined();
        });

         it("Constructors (and parent class constructors) should not be called more than once during initialization.", function(){
            var MyGreatClass = $.Class({
                id: 2,
                initialize: function(id){
                    this.id *= 2;
                }
            });
            var MyGreatSubClass = $.Class(MyGreatClass, { initialize: function(){} });
            var instance = new MyGreatSubClass();
            expect(instance.id).toEqual(4);
        });
    });


    describe("instanceof", function(){
        it("should be true for an object's own class", function() {
            expect(subClassObj instanceof SubClass).toBeTruthy();
            expect(subSubClassObj instanceof SubSubClass).toBeTruthy();
            expect(superClassObj instanceof SuperClass).toBeTruthy();
        });

        it("should be true for all classes further up in the hierarchy", function() {
            expect(subClassObj instanceof SuperClass).toBeTruthy();
            expect(subClassObj instanceof Object).toBeTruthy();

            expect(subSubClassObj instanceof SubClass).toBeTruthy();
            expect(subSubClassObj instanceof SuperClass).toBeTruthy();
            expect(subSubClassObj instanceof Object).toBeTruthy();

            expect(superClassObj instanceof Object).toBeTruthy();
        });

        it("should be false for all classes lower in the hierarchy", function() {
            expect(subClassObj instanceof SubSubClass).toBeFalsy();
            expect(superClassObj instanceof SubClass).toBeFalsy();
        });
    });

    describe("inheritance", function(){
        it("Each subclass should inherit all public properties and methods (except the initializer) from its parent class", function(){
            expect(subClassObj.colorize).toBeDefined();
            expect(SubClass.prototype).toBeDefined();
            expect(subSubClassObj.colorize).toBeDefined();
            expect(subSubClassObj.newMethod).toBeDefined();
            expect(SubSubClass.prototype).toBeDefined();
            expect(superClassObj.colorize).toBe(subClassObj.colorize);
            expect(superClassObj.initialize).not.toBe(subClassObj.initialize);
        });


        it("If a subclass contains properties/methods that exist in the parent class, its version of each should override the parent-class version", function(){
            var superMsg = "Hello from SuperClass";
            expect(superClassObj.setMessage).not.toBe(subClassObj.setMessage);
            expect("__subclasschild__").toEqual(subClassObj.id);

            superClassObj.setMessage(superMsg);
            subClassObj.setMessage(superMsg);
            expect(superMsg).toEqual(superClassObj.message);
            expect(4 + superMsg).toEqual(subClassObj.message);
        })
    });


    describe("$super", function(){
        it("$super() should invoke the parent-class constructor.", function(){

        });
    });

    it("Each instance should have a superClass property which holds a reference to the immediate parent class", function(){
        expect(subClassObj.superClass).toBe(SuperClass);
        expect(subSubClassObj.superClass).toBe(SubClass);
        expect(subSubClassObj.superClass).not.toBe(SuperClass);
    });

    it("should not contain only the expected members, nothing unexpected mixed in", function(){
        expect(SuperClass.isFunction).toBeUndefined();
    });

    it("Instances of classes should contain only the expected members.", function(){
        expect(superClassObj.isFunction).toBeUndefined();
    });


});
