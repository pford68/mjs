<%@tag trimDirectiveWhitespaces="true" dynamic-attributes="html" %>
<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@attribute name="src" required="true" type="java.lang.String" description="The path, relative to the context, to the original script source file." %>
<%@attribute name="development" required="false" type="java.lang.Boolean" description="Whether to use development mode and import required scripts through AJAX." %>
<%@attribute name="debug" required="false" type="java.lang.Boolean" description="Whether to use the debug versions of the script specified in src." %>
<%@attribute name="baseDir" required="false" type="java.lang.String" description="The base directory to use in building pathways to scripts." %>
<%@attribute name="debugFile" required="false" type="java.lang.String" description="The path to the script file to use in debug mode." %>
<%@attribute name="deployFile" required="false" type="java.lang.String" description="The path to the script file to use in production mode." %>

<c:if test="${not fn:endsWith(src, '.js')}">
    <c:set var="src" value="${src}.js"/>
</c:if>

<c:if test="${empty baseDir}">
    <c:set var="baseDir" value="${fn:replace(pageContext.request.requestURL, pageContext.request.requestURI, pageContext.request.contextPath)}"/>
</c:if>
<c:if test="${empty debug}">
    <c:set var="debug" value="${applicationScope.debug}"/>
</c:if>
<c:if test="${empty development}">
    <c:set var="development" value="${applicationScope.development}"/>
</c:if>

<%-- Extracting the fileName from the src in case the mode is development or debug. --%>
<c:choose>
    <c:when test="${fn:contains(src, '/')}">
        <c:set var="fileName" value="${fn:split(src, '/')}"/>
        <c:set var="fileName" value="${fileName[fn:length(fileName) - 1]}"/>
    </c:when>
    <c:otherwise>
         <c:set var="fileName" value="${src}"/>
    </c:otherwise>
</c:choose>

<%-- Below debug overrules all.  If debug is true, development is bypassed.  --%>
<c:choose>
    <c:when test="${not empty baseDir}">
        <c:choose>
            <c:when test="${debug == true && empty debugFile}">
                <c:set var="path" value="${baseDir}/js/build/debug/${fn:replace(fileName, '.js', '')}-debug.js"/>
            </c:when>
            <c:when test="${debug == true && not empty debugFile}">
                <c:set var="path" value="${debugFile}"/>
            </c:when>
            <c:when test="${development == false && empty deployFile}">
                <c:set var="path" value="${baseDir}/js/build/minified/${fn:replace(fileName, '.js', '')}-min.js"/>
            </c:when>
            <c:when test="${development == false && not empty deployFile}">
                <c:set var="path" value="${deployFile}"/>
            </c:when>
            <c:otherwise>
                <c:set var="path" value="${baseDir}/${src}"/>
            </c:otherwise>
        </c:choose>
        <c:set var="path" value="${fn:replace(path, '//', '/')}" />
        <c:set var="path" value="${fn:replace(path, ':/', '://')}" />
        <script type="text/javascript" src="${path}"></script>
    </c:when>
    <c:otherwise>
        <span class="error">
            [script.tag] The location of the production and debug scripts is missing.
            Specify it either in lib or in applicationScope.js.lib.
        </span>
    </c:otherwise>
</c:choose>